FROM node:25-alpine3.22 AS build

WORKDIR /app

ARG POSTGRES_URL
ARG DISCORD_CLIENT_CALLBACK_URL
ARG GITHUB_CLIENT_CALLBACK_URL
ARG GOOGLE_CLIENT_CALLBACK_URL
ARG GOOGLE_CLIENT_ID
ARG GOOGLE_CLIENT_SECRET
ARG DISCORD_CLIENT_ID
ARG DISCORD_CLIENT_SECRET
ARG GITHUB_CLIENT_ID
ARG GITHUB_CLIENT_SECRET
ARG JWT_SECRET
ARG FRONTEND_URLS
ENV POSTGRES_URL=${POSTGRES_URL}
ENV DISCORD_CLIENT_CALLBACK_URL=${DISCORD_CLIENT_CALLBACK_URL}
ENV GITHUB_CLIENT_CALLBACK_URL=${GITHUB_CLIENT_CALLBACK_URL}
ENV GOOGLE_CLIENT_CALLBACK_URL=${GOOGLE_CLIENT_CALLBACK_URL}
ENV GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
ENV GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
ENV DISCORD_CLIENT_ID=${DISCORD_CLIENT_ID}
ENV DISCORD_CLIENT_SECRET=${DISCORD_CLIENT_SECRET}
ENV GITHUB_CLIENT_ID=${GITHUB_CLIENT_ID}
ENV GITHUB_CLIENT_SECRET=${GITHUB_CLIENT_SECRET}
ENV POSTGRES_URL=${POSTGRES_URL}
ENV JWT_SECRET=${JWT_SECRET}
ENV FRONTEND_URLS=${FRONTEND_URLS}

COPY package.json ./

RUN npm i

COPY . .

RUN npm run prisma:generate && npm run build

FROM node:25-alpine3.22

WORKDIR /app

COPY package.json ./

RUN npm install --omit=dev && npm cache clean --force

COPY --from=build /app/dist ./dist
COPY --from=build /app/node_modules/.prisma/client ./node_modules/.prisma/client

CMD ["node", "dist/main.js"]
