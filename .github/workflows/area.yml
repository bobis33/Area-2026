name: 'CI - Build'
run-name: 'Build - "${{ github.ref_name }}"'
permissions:
  contents: read
on:
  push:
    branches:
      - "main"

  pull_request:
    branches:
      - "**"

  workflow_dispatch:

jobs:

  build-docker-containers:
    name: 'Build and run Docker containers'
    if: github.actor != 'dependabot[bot]'
    runs-on: ubuntu-24.04
    timeout-minutes: 20
    defaults:
      run:
        shell: bash
        working-directory: .
    env:
      PROJECT_NAME: area
    steps:

      - name: 'Checkout repository'
        uses: actions/checkout@v6.0.1
        with:
          ref: ${{ github.ref }}
          repository: '${{ github.repository }}'
          fetch-depth: 1
          submodules: false

      - name: 'Create .env file'
        run: |
          echo "VERSION=0.0.0" >> .env
          echo "PROJECT_NAME=area" >> .env
          echo "MODE=development" >> .env
          
          echo "API_CONTAINER_PORT=8080" >> .env
          echo "WEB_CONTAINER_PORT=8081" >> .env
          echo "MOBILE_CONTAINER_PORT=8082" >> .env
          
          echo "API_URL=http://localhost:8080" >> .env
          echo "FRONTEND_URLS=http://localhost:8081,http://localhost:8082" >> .env
          
          echo "POSTGRES_DB=area_database" >> .env
          echo "POSTGRES_USER=area_postgres-user" >> .env
          echo "POSTGRES_PASSWORD=area_postgres-password" >> .env
          echo "POSTGRES_CONTAINER_PORT=8000" >> .env
          echo "POSTGRES_URL=postgresql://area_postgres-user:area_postgres-password@area_postgresql:8000/area_database" >> .env

          echo "GOOGLE_CLIENT_ID=" >> .env
          echo "GOOGLE_CLIENT_SECRET=" >> .env
          echo "GOOGLE_CLIENT_CALLBACK_URL=http://localhost:8080/auth/google/callback" >> .env
          
          echo "GITHUB_CLIENT_ID=" >> .env
          echo "GITHUB_CLIENT_SECRET=" >> .env
          echo "GITHUB_CLIENT_CALLBACK_URL=http://localhost:8080/auth/github/callback" >> .env
          
          echo "DISCORD_CLIENT_ID=" >> .env
          echo "DISCORD_CLIENT_SECRET=" >> .env
          echo "DISCORD_CLIENT_CALLBACK_URL=http://localhost:8080/auth/discord/callback" >> .env
          
          echo "JWT_SECRET=jwt-secret-key" >> .env

      - name: 'Build'
        run: docker compose build --progress plain --no-cache area_service_postgresql area_service_server area_service_client_web

      - name: 'Run'
        run: docker compose up -d area_service_postgresql area_service_server area_service_client_web

      - name: 'Check containers status'
        run: |
          set -e
          echo "Containers status:"
          docker compose ps
          
          echo "⏳ Waiting for containers to become healthy..."
          TIMEOUT=60
          INTERVAL=3
          elapsed=0
          
          while [ $elapsed -lt $TIMEOUT ]; do
            unhealthy=$(docker ps --filter "health=unhealthy" -q | wc -l)
            starting=$(docker ps --filter "health=starting" -q | wc -l)
            if [ "$unhealthy" -eq 0 ] && [ "$starting" -eq 0 ]; then
              echo "✅ All containers are healthy"
              break
            fi
            sleep $INTERVAL
            elapsed=$((elapsed + INTERVAL))
            echo "Waiting... (${elapsed}s/${TIMEOUT}s)"
          done
          
          if [ $elapsed -ge $TIMEOUT ]; then
            echo "❌ Timeout: Some containers are not healthy"
            docker compose ps
            exit 1
          fi
